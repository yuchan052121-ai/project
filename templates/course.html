{% extends "layout.html" %}
{% block content %}

<h2>{{ course['code'] }} — {{ course['title'] }}</h2>

<p>
  専攻区分: {{ course['area'] or '-' }} /
  標準履修年次: {{ course['grade'] or '-' }} /
  時間割: {{ course['timetable'] or '-' }}
</p>

<hr>

<!-- フィルタ（おすすめ最小値） -->
<form method="get" action="{{ url_for('course_view', course_id=course['id']) }}">
  <label>
    おすすめ評価で絞り込み（最小）:
    <select name="min_recommend" onchange="this.form.submit()">
      <option value="">すべて</option>
      {% for r in [5,4,3,2,1] %}
        <option value="{{ r }}" {% if min_recommend==r %}selected{% endif %}>
          {{ r }} 以上
        </option>
      {% endfor %}
    </select>
  </label>
</form>

<p>合計レビュー数: {{ total }}</p>

<!-- 平均評価 -->
{% if avg %}
<div class="avg-box">
  <h3>平均評価</h3>
  <ul>
    <li>おすすめ: {{ "%.2f"|format(avg.recommend) }}</li>
    <li>難易度: {{ "%.2f"|format(avg.difficulty) }}</li>
    <li>楽しさ: {{ "%.2f"|format(avg.fun) }}</li>
    <li>学び: {{ "%.2f"|format(avg.learning) }}</li>
  </ul>
</div>
{% endif %}

<hr>

<!-- レビュー一覧 -->
{% if reviews %}
<ul class="reviews">
  {% for r in reviews %}
  <li>
    <div class="review-head">
      <strong>
        おすすめ {{ r['recommend'] }} /
        難易度 {{ r['difficulty'] }} /
        楽しさ {{ r['fun'] }} /
        学び {{ r['learning'] }}
      </strong>
      <span class="meta">（投稿: {{ r['created_at'] }}）</span>
    </div>

    <div class="comment">
      {{ r['comment'] }}
    </div>
  </li>
  {% endfor %}
</ul>

<!-- ページャ -->
<div class="pager">
  {% if has_prev %}
    <a href="{{ url_for(
      'course_view',
      course_id=course['id'],
      page=page-1,
      min_recommend=min_recommend
    ) }}">&laquo; 前へ</a>
  {% endif %}

  <span>ページ {{ page }} / {{ pages }}</span>

  {% if has_next %}
    <a href="{{ url_for(
      'course_view',
      course_id=course['id'],
      page=page+1,
      min_recommend=min_recommend
    ) }}">次へ &raquo;</a>
  {% endif %}
</div>

{% else %}
<p>レビューはまだありません。</p>
{% endif %}

<hr>

<p>
  <a href="{{ url_for('add_review', course_id=course['id']) }}">
    レビューを書く
  </a>
</p>

<!-- レビュー取消 -->
<form method="post" action="{{ url_for('cancel_review', course_id=course['id']) }}">
  <label>
    取消するレビューの名前（投稿時と同じ）:
    <input name="name" required>
  </label>
  <button type="submit">レビューを取消</button>
</form>

{% endblock %}
